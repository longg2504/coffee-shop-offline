<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard Coffee</title>
    <th:block th:replace="/layout/head :: head"></th:block>
    <link rel="stylesheet" href="/assets/bootstrap/v.5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/styles.css">



</head>

<body>
<div id="wrapper">
    <th:block th:replace="/layout/topbar :: topbar"></th:block>
    <th:block th:replace="/layout/left-sidebar :: left-sidebar"></th:block>

    <div class="content-page">
        <div class="content">
            <div class="container-fluid">
                <div class="table-title">
                    <div class="row">
                        <div class="col-sm-4">
                            <h1>Danh sách nhân viên</h1>
                        </div>
                        <div class="col-sm-8">
                            <button type="button" class="btn btn-outline-light" id="btnShowModalCreate">
                                <i class=" fa-solid fa-plus"></i>
                                Thêm nhân viên
                            </button>
                        </div>
                    </div>
                </div>

                <!--                <th:block th:replace="/dashboard/modal-create :: modal-create"></th:block>-->

                <div class="row">
                    <input type="hidden" id="currentRow"/>

                    <table id="tbStaff" class="table table-hover ">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Ảnh</th>
                            <th>Họ tên</th>
                            <th>Số điện thoại</th>
                            <th>Province</th>
                            <th>District</th>
                            <th>Ward</th>
                            <th>Address</th>
                            <th>Vai trò</th>
                            <th colspan="2">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <th:block th:replace="/layout/footer :: footer"></th:block>
</div>

<th:block th:replace="/layout/script :: script"></th:block>
<th:block th:replace="/dashboard/modalCreateStaff "></th:block>




<script src="/assets/jquery/jquery-3.7.0.min.js"></script>
<script src="/assets/jquery/jquery.validate.js"></script>
<script src="/assets/bootstrap/v.5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="/assets/sweetalert2/sweetalert2.all.min.js"></script>
<script src="/assets/js/magnific-popup-1.1.0.js"></script>
<script src="/assets/js/app.js"></script>


<script>
    const page = {
        url: {
            getAllStaff: App.API_STAFF,
            create: App.API_STAFF
        },
        elements: {},
        loadData: {},
        commands: {},
        dialogs: {
            elements: {},
            commands: {},
            loadData: {}
        }
    }

    let locationRegion = new LocationRegion();
    let staff = new Staff();
    let user = new User();


    page.elements.tbStaffBody = $('#tbStaff tbody')
    page.elements.roleSpan = $('#roleSpan')
    page.elements.roleSelect = $('#roleSelect')

    page.elements.btnShowModalCreate = $('#btnShowModalCreate');
    page.elements.modalCreate = $('#modalCreate');
    page.elements.formCreate = $('#formCreate');
    page.elements.titleCre = $('#titleCre');
    page.elements.phoneCre = $('#phoneCre');
    page.elements.provinceCre = $('#provinceCre');
    page.elements.districtCre = $('#districtCre');
    page.elements.wardCre = $('#wardCre');
    page.elements.addressCre = $('#addressCre');
    page.elements.errorAreaCreate = $('#modalCreate .error-area')
    page.elements.btnCreate = $('#btnCreate');

    page.commands.renderStaff = (staff) => {
        let imageThumbnail = App.BASE_URL_CLOUD_IMAGE + "/" + App.BASE_SCALE_IMAGE + "/" + staff.staffAvatar.fileFolder + "/" + staff.staffAvatar.fileName;
        return `
                <tr>
                    <td>${staff.id}</td>
                    <td><img src="${imageThumbnail}" alt="" /></td>
                    <td>${staff.title}</td>
                    <td>${staff.phone}</td>
                    <td>${staff.locationRegion.provinceName}</td>
                    <td>${staff.locationRegion.districtName}</td>
                    <td>${staff.locationRegion.wardName}</td>
                    <td>${staff.locationRegion.address}</td>
                    <td><span id="roleSpan">
                            ${staff.user.role.code}
                        </span>
                        <select class="form-select" name="role" id="roleSelect" hidden="true">
                        </select>
                    </td>

                    <td>
                        <button class="btn btn-outline-secondary edit" data-id="${staff.id}">
                            <i class="fas fa-user-edit"></i>
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-outline-danger">
                            <i class="fas fa-user-slash"></i>
                        </button>
                    </td>
                </tr>
            `
    }


    page.commands.getAllStaff = () => {
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            type: 'GET',
            url: page.url.getAllStaff
        })
            .done((data) => {
                $.each(data, (index, item) => {
                    const str = page.commands.renderStaff(item)
                    page.elements.tbStaffBody.append(str)
                })
                // page.commands.updateRole();
            })
            .fail(function () {
                App.SweetAlert.showErrorAlert(App.AlertMessageVi.ERROR_404);
            });
    }

    // page.commands.getRoles = () => {
    //     $.ajax({
    //         headers: {
    //             'Accept': 'application/json',
    //             'Content-Type': 'application/json'
    //         },
    //         type: 'GET',
    //         url: page.url.getAllRole,
    //     })
    //         .done((data) => {
    //             page.elements.roleSelect.empty();
    //             $.each(data, function (index, item) {
    //                 page.elements.roleSelect.append($('<option>').val(item.id).text(item.code));
    //             })
    //         })
    //         .fail(function () {
    //             App.SweetAlert.showErrorAlert(App.AlertMessageVi.ERROR_404);
    //         });
    // }

    // page.commands.updateRole = () => {
    //     $('.update-role').on('click', () => {
    //         page.elements.roleSpan.hide();
    //         page.elements.roleSelect.removeAttr('hidden').show()
    //         page.commands.getRoles();
    //     })
    //
    // }

    page.commands.getAllProvinces = () => {
        return   $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/'
        })
            .done((data) => {
                const provinces = data.results;
                page.elements.provinceCre.empty();
                // page.dialogs.elements.provinceUpdate.empty();

                $.each(provinces, (index, item) => {

                    const str = `<option value="${item.province_id}">${item.province_name}</option>`
                    page.elements.provinceCre.append(str);
                    //page.dialogs.elements.provinceUpdate.append(str);

                })
            })
    }

    page.commands.getALlDistricts = (provinceId, elementSelect) => {
        return $.ajax({
            type: 'GET',
            url:  'https://vapi.vnappmob.com/api/province/district/' + provinceId
        })
            .done((data) => {
                const districts = data.results;
                elementSelect.empty();

                $.each(districts, (index, item) => {
                    const str = `<option value="${item.district_id}">${item.district_name}</option>`;
                    elementSelect.append(str);
                });
            })
    }
    page.commands.getAllWards = (districtId, elementSelect) => {
        return  $.ajax({
            type: 'GET',
            url:'https://vapi.vnappmob.com/api/province/ward/' + districtId
        })
            .done((data) => {
                const wards = data.results;

                elementSelect.empty();

                $.each(wards, (index, item) => {
                    const str = `<option value="${item.ward_id}">${item.ward_name}</option>`;
                    elementSelect.append(str);
                });
            });
    }



    page.commands.handleCreateStaff = () => {
        page.elements.btnCreate.attr('disabled', true);

        let load = webToast.loading({
            status: 'Loading...',
            message: 'Please Wait a moment',
            align: 'bottomright',
            line: true,
        });

        locationRegion.id = null;
        locationRegion.provinceId = page.elements.provinceCre.val();
        locationRegion.provinceName = page.elements.provinceCre.find('option:selected').text();
        locationRegion.districtId = page.elements.districtCre.val();
        locationRegion.districtName = page.elements.districtCre.find('option:selected').text();
        locationRegion.wardId = page.elements.wardCre.val();
        locationRegion.wardName = page.elements.wardCre.find('option:selected').text();
        locationRegion.address = page.elements.addressCre.val();


        staff.id = null;
        staff.title = page.elements.titleCre.val();
        staff.phone = page.elements.phoneCre.val();
        staff.locationRegion = locationRegion;
        staff.user = user;

        const file = $('#avatarCre')[0].files[0];
        let formData = new FormData();
        formData.append('title', staff.title);
        formData.append('phone', staff.phone);
        formData.append('provinceId', locationRegion.provinceId);
        formData.append('provinceName', locationRegion.provinceName);
        formData.append('districtId', locationRegion.districtId);
        formData.append('districtName', locationRegion.districtName);
        formData.append('wardId', locationRegion.wardId);
        formData.append('wardName', locationRegion.wardName);
        formData.append('address', locationRegion.address);
        formData.append('avatar', file);


        setTimeout(() => {
            $.ajax({
                type: "POST",
                contentType: false,
                cache: false,
                processData: false,
                url: page.url.create,
                data: formData
            })
                .done((data) => {
                    const avatar = data.avatar;
                    const str = page.commands.renderStaff(data, avatar);
                    page.elements.tbStaffBody.prepend(str);

                    page.elements.modalCreate.modal('hide');

                    webToast.Success({
                        status: 'Thêm mới thành công',
                        message: '',
                        delay: 2000,
                        align: 'topright'
                    });

                })
                .fail((error) => {
                    console.log(error);
                })
                .always(() => {
                    page.elements.btnCreate.attr('disabled', false);
                    load.remove();
                })
        }, 1000);
    }

    page.commands.onchangeProvince = (provinceId, districtElement, wardElement) => {
        page.commands.getALlDistricts(provinceId, districtElement).then(() => {
            const districtId = districtElement.val();
            page.commands.getAllWards(districtId, wardElement);
        })
    }
    page.initializeControlEvent = () => {
        page.elements.provinceCre.on('change', function () {
            const provinceId = $(this).val();
            page.commands.onchangeProvince(provinceId, page.elements.districtCre, page.elements.wardCre);
        })
        page.elements.districtCre.on('change', function () {
            const districtId = $(this).val();
            page.commands.getAllWards(districtId, page.elements.wardCre);
        })

        page.elements.btnShowModalCreate.on('click', () => {
            page.elements.modalCreate.modal('show');
        })

        page.elements.btnCreate.on('click', () => {
            page.elements.formCreate.trigger("submit");
        })

        page.elements.tbStaffBody.on('click','.edit',function () {

            alert("ok");
        })
    }

    page.elements.formCreate.validate({
        rules: {
            titleCre: {
                required: true,
            },
            phoneCre: {
                required: true,
            }
        },
        messages: {
            titleCre: {
                required: "Vui lòng nhập họ và tên",
            },
            phoneCre: {
                required: "Vui lòng nhập số điện thoại",
            }
        },
        errorLabelContainer: "#modalCreate .modal-alert-danger",
        errorPlacement: function (error, element) {
            error.appendTo("#modalCreate .modal-alert-danger");
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalCreate .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalCreate .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#formCreate input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            page.commands.handleCreateStaff();
        }
    })

    page.loadData = () => {
        page.commands.getAllStaff();

        page.commands.getAllProvinces().then(() => {
            const provinceId = page.elements.provinceCre.val();

            page.commands.getALlDistricts(provinceId, page.elements.districtCre).then(() => {
                const districtId = page.elements.districtCre.val();
                page.commands.getAllWards(districtId, page.elements.wardCre);
            });
        });
    }

    $(() => {
        page.loadData();
        page.initializeControlEvent();
    })

</script>

</body>
</html>